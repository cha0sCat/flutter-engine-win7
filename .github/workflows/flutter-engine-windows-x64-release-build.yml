name: Build Flutter Engine (Win7)

on:
  workflow_dispatch:
    inputs:
      flutter_ref:
        description: Flutter tag/branch/commit
        required: true
        default: 3.38.3
      enable_tmate:
        description: Enable interactive tmate session
        required: true
        type: boolean
        default: false

jobs:
  build-engine:
    runs-on: windows-2022

    steps:
      - name: Checkout patches repo
        uses: actions/checkout@v4

      - name: Install Depot Tools
        uses: newkdev/setup-depot-tools@v1.0.1

      - name: Set environment variables
        run: |
          echo "DEPOT_TOOLS_WIN_TOOLCHAIN=0" >> $env:GITHUB_ENV
          echo "WINDOWSSDKDIR=C:\Program Files (x86)\Windows Kits\10" >> $env:GITHUB_ENV

          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          $vsPath = & $vswhere -products * -latest -property installationPath
          if (-not $vsPath) {
            throw "Visual Studio not found via vswhere at $vswhere"
          }
          echo "GYP_MSVS_OVERRIDE_PATH=$vsPath" >> $env:GITHUB_ENV

      # - name: Setup tmate session
      #   uses: mxschmitt/action-tmate@v3
      #   if: ${{ inputs.enable_tmate }}
      #   with:
      #     limit-access-to-actor: true

      - name: Checkout Flutter (3.38.3+)
        uses: actions/checkout@v4
        with:
          repository: flutter/flutter
          path: flutter
          ref: ${{ inputs.flutter_ref }}
          fetch-depth: 1

      - name: gclient sync
        working-directory: flutter
        run: |
          Copy-Item -Force engine\scripts\standard.gclient .gclient
          gclient sync -D

      - name: Apply Win7 patches
        working-directory: flutter
        run: |
          $patchRoot = "${{ github.workspace }}"

          function Apply-PatchIfNeeded([string]$dir, [string]$patchPath) {
            git apply --check --directory=$dir $patchPath
            if ($LASTEXITCODE -eq 0) {
              git apply --directory=$dir $patchPath
              if ($LASTEXITCODE -ne 0) {
                throw "Failed to apply patch: $patchPath"
              }
              return
            }

            git apply --reverse --check --directory=$dir $patchPath
            if ($LASTEXITCODE -eq 0) {
              Write-Host "Patch already applied: $patchPath"
              return
            }

            throw "Patch does not apply: $patchPath"
          }

          Apply-PatchIfNeeded "engine/src/flutter" "$patchRoot\0001-hex_codec-include-string.patch"
          Apply-PatchIfNeeded "engine/src/flutter/third_party/dart" "$patchRoot\0001-revert-platform_win.cc.patch"
          Apply-PatchIfNeeded "engine/src/flutter/third_party/dart" "$patchRoot\0001-Revert-win-unwinding-Remove-Windows7-handling-of-unw.patch"
          Apply-PatchIfNeeded "engine/src/flutter/third_party/dart" "$patchRoot\0001-revert-file_win.cc.patch"

      - name: Build engine
        working-directory: flutter/engine/src
        run: |
          python .\flutter\tools\gn --runtime-mode=release --no-prebuilt-dart-sdk
          ninja -C .\out\host_release

      - name: Package artifacts
        working-directory: flutter/engine/src
        run: |
          $outputPath = "${{ github.workspace }}\windows-x64-release.zip"

          $stageDir = Join-Path $PWD "stage"
          if (Test-Path $stageDir) {
            Remove-Item -Recurse -Force $stageDir
          }
          New-Item -ItemType Directory -Force -Path $stageDir | Out-Null

          $filesToStage = @(
            ".\\out\\host_release\\flutter_windows.dll",
            ".\\out\\host_release\\flutter_windows.dll.pdb",
            ".\\out\\host_release\\flutter_windows.dll.exp",
            ".\\out\\host_release\\flutter_windows.dll.lib",
            ".\\out\\host_release\\gen_snapshot.exe",
            ".\\flutter\\shell\\platform\\windows\\public\\flutter_windows.h",
            ".\\flutter\\shell\\platform\\common\\public\\flutter_export.h",
            ".\\flutter\\shell\\platform\\common\\public\\flutter_messenger.h",
            ".\\flutter\\shell\\platform\\common\\public\\flutter_plugin_registrar.h",
            ".\\flutter\\shell\\platform\\common\\public\\flutter_texture_registrar.h",
            ".\\out\\host_release\\gen\\flutter\\build\\archives\\LICENSE.windows_flutter.md"
          )

          foreach ($file in $filesToStage) {
            if (-not (Test-Path $file)) {
              throw "Missing build output file: $file"
            }
            Copy-Item -Force $file (Join-Path $stageDir ([System.IO.Path]::GetFileName($file)))
          }

          $license = Join-Path $stageDir "LICENSE.windows_flutter.md"
          if (Test-Path $license) {
            Rename-Item -Force $license "license.windows_flutter.md"
          }

          Compress-Archive -Path (Join-Path $stageDir "*") -DestinationPath $outputPath

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-release
          path: windows-x64-release.zip
          retention-days: 90
